<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vnua.mapper.LoginMapper">

    <select id="findByUsernameAndPassword" resultType="com.vnua.model.SysUser">
        SELECT
        user_id,
        login_name,
        password,
        user_name AS username,
        email,
        role,
        user_type AS userType,
        dept_id AS deptId,
        del_flag
        FROM sys_user
        WHERE login_name = #{login_name}
        AND password = #{password}
        AND ISNULL(del_flag, 0) = 0
    </select>

    <update id="updateLoginDate">
        UPDATE sys_user
        SET login_date = GETDATE()
        WHERE user_id = #{id}
    </update>

    <select id="logFullName" resultType="com.vnua.model.SysUser">
        SELECT user_name AS username
        FROM sys_user
        WHERE login_name = #{login_name}
    </select>

    <select id="showProfile" resultType="com.vnua.model.SysUser">
        SELECT
        user_id,
        login_name,
        user_name AS username,
        email AS email,
        role,
        ISNULL(del_flag, 0) as delFlag,
        user_type AS userType
        FROM sys_user
        ORDER BY
        RIGHT(user_name, CHARINDEX(' ', REVERSE(user_name) + ' ') - 1),
        user_name
    </select>

    <update id="del">
        UPDATE sys_user
        SET del_flag = 1
        WHERE user_id = #{user_id}
    </update>

    <select id="findByLoginname" resultType="com.vnua.model.SysUser">
        SELECT
            user_id,
            login_name AS login_name,
            password,
            user_name AS username,
            email,
            role,
            user_type AS userType,
            del_flag
        FROM sys_user
        WHERE login_name = #{login_name}
          AND del_flag = 0
    </select>

    <select id="findById" resultType="com.vnua.model.SysUser">
        SELECT
        user_id,
        login_name AS login_name,
        password,
        user_name AS username,
        email,
        b.dept_name as role,
        user_type AS userType,
        del_flag
        FROM sys_user a left join dept b on a.dept_id = b.dept_id
        where user_id = #{user_id}
    </select>

    <update id="updateProfile" parameterType="com.vnua.model.SysUser">
        UPDATE sys_user
        SET
        user_name = #{username},
        email = #{email},
        role = #{role},
        user_type = #{userType}
        <if test="password != null and password != ''">
            , password = #{password}
        </if>
        WHERE user_id = #{user_id}
    </update>

    <insert id="insertUser" parameterType="com.vnua.model.SysUser"
            useGeneratedKeys="true" keyProperty="user_id">
        INSERT INTO sys_user (
        login_name, password, user_name, email, role, user_type, del_flag
        ) VALUES (
        #{login_name},
        #{password},
        #{username},
        #{email},
        #{role},
        #{userType},
        0
        )
    </insert>

</mapper>