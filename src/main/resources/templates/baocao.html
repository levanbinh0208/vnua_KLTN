<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>BÃ¡o cÃ¡o thá»‘ng kÃª toÃ n diá»‡n</title>
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .stat-card { background: white; padding: 16px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); text-align: center; }
    .stat-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: #2c3e50; }
    .stat-value { font-size: 2.2rem; font-weight: 700; color: #3498db; margin: 5px 0; }
    .stat-pending { font-size: 0.9rem; color: #e74c3c; }

    /* Tab */
    .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin: 20px 0; }
    .tab-btn {
      padding: 10px 16px;
      background: #e0e0e0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .tab-btn:hover { background: #d0d0d0; }
    .tab-btn.active { background: #3498db; color: white; }

    /* Chart */
    .chart-section { margin-top: 30px; }
    .chart-container { display: none; }
    .chart-container.active { display: block; }
    .chart-title { margin: 15px 0 10px; color: #2c3e50; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“Š BÃ¡o cÃ¡o thá»‘ng kÃª toÃ n diá»‡n</h1>
    <p>Cáº­p nháº­t lÃºc: <span th:text="${#dates.format(#dates.createNow(), 'dd/MM/yyyy HH:mm')}"></span></p>
  </div>

  <!-- ğŸ“Š Tá»•ng quan -->
  <div class="section">
    <h2 class="section-title">ğŸ“ˆ Tá»•ng quan theo loáº¡i</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px;">
      <div class="stat-card">
        <div class="stat-title">ğŸ“‘ BÃ i bÃ¡o</div>
        <div class="stat-value" th:text="${totalPublications} ?: 0">0</div>
        <div class="stat-pending" th:text="'â³ ' + (${pendingPublications} ?: 0) + ' chá» duyá»‡t'">â³ 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">ğŸ¯ Äá» tÃ i</div>
        <div class="stat-value" th:text="${totalProjects} ?: 0">0</div>
        <div class="stat-pending" th:text="'â³ ' + (${pendingProjects} ?: 0) + ' chá» duyá»‡t'">â³ 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">ğŸ¤ Há»™i tháº£o</div>
        <div class="stat-value" th:text="${totalConferences} ?: 0">0</div>
        <div class="stat-pending" th:text="'â³ ' + (${pendingConferences} ?: 0) + ' chá» duyá»‡t'">â³ 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">ğŸ“š SÃ¡ch</div>
        <div class="stat-value" th:text="${totalBooks} ?: 0">0</div>
        <div class="stat-pending" th:text="'â³ ' + (${pendingBooks} ?: 0) + ' chá» duyá»‡t'">â³ 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">ğŸ”¬ Báº±ng SC</div>
        <div class="stat-value" th:text="${totalPatents} ?: 0">0</div>
        <div class="stat-pending" th:text="'â³ ' + (${pendingPatents} ?: 0) + ' chá» duyá»‡t'">â³ 0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">ğŸ“ HÆ°á»›ng dáº«n</div>
        <div class="stat-value" th:text="${totalSupervisions} ?: 0">0</div>
        <div class="stat-pending" th:text="'â³ ' + (${pendingSupervisions} ?: 0) + ' chá» duyá»‡t'">â³ 0</div>
      </div>
    </div>
  </div>

  <!-- ğŸ” Tab biá»ƒu Ä‘á»“ -->
  <div class="chart-section">
    <h2 class="section-title">ğŸ“Š Biá»ƒu Ä‘á»“ theo phÃ²ng ban</h2>
    <div class="tabs">
      <button class="tab-btn active" data-tab="publication">ğŸ“‘ BÃ i bÃ¡o</button>
      <button class="tab-btn" data-tab="project">ğŸ¯ Äá» tÃ i</button>
      <button class="tab-btn" data-tab="conference">ğŸ¤ Há»™i tháº£o</button>
      <button class="tab-btn" data-tab="book">ğŸ“š SÃ¡ch</button>
      <button class="tab-btn" data-tab="patent">ğŸ”¬ Báº±ng SC</button>
      <button class="tab-btn" data-tab="supervision">ğŸ“ HÆ°á»›ng dáº«n</button>
    </div>

    <!-- 6 biá»ƒu Ä‘á»“ -->
    <div class="chart-container active" id="tab-publication">
      <h3 class="chart-title">ğŸ“ˆ BÃ i bÃ¡o theo phÃ²ng ban</h3>
      <canvas id="chart-publication" height="100"></canvas>
    </div>
    <div class="chart-container" id="tab-project">
      <h3 class="chart-title">ğŸ“ˆ Äá» tÃ i theo phÃ²ng ban</h3>
      <canvas id="chart-project" height="100"></canvas>
    </div>
    <div class="chart-container" id="tab-conference">
      <h3 class="chart-title">ğŸ“ˆ Há»™i tháº£o theo phÃ²ng ban</h3>
      <canvas id="chart-conference" height="100"></canvas>
    </div>
    <div class="chart-container" id="tab-book">
      <h3 class="chart-title">ğŸ“ˆ SÃ¡ch theo phÃ²ng ban</h3>
      <canvas id="chart-book" height="100"></canvas>
    </div>
    <div class="chart-container" id="tab-patent">
      <h3 class="chart-title">ğŸ“ˆ Báº±ng sÃ¡ng cháº¿ theo phÃ²ng ban</h3>
      <canvas id="chart-patent" height="100"></canvas>
    </div>
    <div class="chart-container" id="tab-supervision">
      <h3 class="chart-title">ğŸ“ˆ HÆ°á»›ng dáº«n theo phÃ²ng ban</h3>
      <canvas id="chart-supervision" height="100"></canvas>
    </div>
  </div>
</div>
<script th:inline="javascript">
  /*<![CDATA[*/
  const deptData = {
    publication: [[${publicationsByDept}]],
    project: [[${projectsByDept}]],
    conference: [[${conferencesByDept}]],
    book: [[${booksByDept}]],
    patent: [[${patentsByDept}]],
    supervision: [[${supervisionsByDept}]]
  };
  /*]]>*/

  const renderedCharts = {};

  function renderChart(tab) {
    if (renderedCharts[tab]) return;

    const canvasId = 'chart-' + tab;
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    const data = deptData[tab] || [];
    const labels = data.map(i => i.dept ?? 'KhÃ¡c');
    const values = data.map(i => Number(i.cnt) || 0);

    renderedCharts[tab] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: 'rgba(52,152,219,0.7)',
          borderColor: '#2980b9',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // render tab Ä‘áº§u tiÃªn
    renderChart('publication');

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // active tab
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.chart-container').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.getElementById('tab-' + tab).classList.add('active');

        // váº½ chart khi click
        setTimeout(() => renderChart(tab), 50);
      });
    });
  });
</script>

</body>
</html>